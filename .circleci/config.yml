version: 2
jobs:
  build:
    docker:
      - image: ocaml/opam:alpine_ocaml-4.06.0
        environment:
          TERM: xterm
    steps:
      - checkout
      - run:
          name: Install Alpine packages
          command: sudo apk update && sudo apk add git m4 mpd
      - run:
          name: Install OCaml packages.
          command: opam switch 4.07.0
                   && eval `opam config env`
                   && opam update -y
                   && opam upgrade -y
                   && opam install -y lwt cmdliner jbuilder odoc ounit bisect_ppx dune
      - run:
          name: Create user to run mpd
          command: sudo addgroup -S ocaml-libmpdclient
                   && sudo adduser -S -G ocaml-libmpdclient ocaml-libmpdclient
                   && echo "ocaml-libmpdclient ALL=(ALL:ALL) NOPASSWD:ALL"
                   | sudo EDITOR=tee visudo -f /etc/sudoers.d/ocaml-libmpdclient
      - run:
          name: Prepare the mpd data for tests.
          command: mkdir -p /tmp/mpd/music
                  && mkdir /tmp/mpd/playlists
                  && cp .travis/*.mp3 /tmp/mpd/music/
                  && ls -1 /tmp/mpd/music/ > /tmp/mpd/playlists/bach.m3u
                  && echo "/tmp/mpd/music/kunst01.mp3" > /tmp/mpd/playlists/bach1.m3u
                  && sudo chown -R ocaml-libmpdclient:ocaml-libmpdclient /tmp/mpd
      - run:
          name: Run Mpd server in background.
          command: sudo mpd .travis/mpd.conf
                   && cat /tmp/mpd/mpd.log
                   && cat /tmp/mpd.error
          background: true
      - run:
          name: Run the tests
          command: eval `opam config env` && make test
